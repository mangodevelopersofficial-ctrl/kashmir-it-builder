async function startCloudBuild() {
    const token = document.getElementById('ghToken').value;
    const repo = "mangodevelopersofficial-ctrl/kashmir-it-builder";
    const status = document.getElementById('status');
    
    // UI Elements
    const appName = document.getElementById('appName').value;
    const pkgName = document.getElementById('pkgName').value;
    const splashTime = document.getElementById('splashTime').value;
    const htmlCode = document.getElementById('htmlCode').value;
    const iconFile = document.getElementById('appIcon').files[0];

    status.style.display = "block";
    status.innerHTML = "üöÄ Initializing Auto-Sync...";

    async function uploadToGithub(fileName, content, isBinary = false) {
        const url = `https://api.github.com/repos/${repo}/contents/${fileName}`;
        const getFile = await fetch(url, { headers: { 'Authorization': `token ${token}` } });
        const fileData = await getFile.json();
        const sha = fileData.sha ? fileData.sha : null;

        await fetch(url, {
            method: 'PUT',
            headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({
                message: `Update ${fileName} from Mango Dashboard`,
                content: isBinary ? content : btoa(content),
                sha: sha
            })
        });
    }

    try {
        // 1. Upload HTML
        status.innerHTML = "üìù Uploading HTML Content...";
        await uploadToGithub('index.html', htmlCode);

        // 2. Upload Icon (If selected)
        if (iconFile) {
            status.innerHTML = "üñºÔ∏è Uploading App Icon...";
            const reader = new FileReader();
            reader.readAsDataURL(iconFile);
            reader.onload = async () => {
                const base64Icon = reader.result.split(',')[1];
                await uploadToGithub('icon.png', base64Icon, true);
            };
        }

        // 3. Trigger Build
        status.innerHTML = "‚öôÔ∏è Triggering Cloud Engine...";
        const res = await fetch(`https://api.github.com/repos/${repo}/actions/workflows/build.yml/dispatches`, {
            method: 'POST',
            headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github+json' },
            body: JSON.stringify({ 
                ref: 'main',
                inputs: { app_name: appName, package_name: pkgName, splash_time: splashTime }
            })
        });

        if(res.ok) {
            status.innerHTML = "‚úÖ SUCCESS! Your custom app is being built. Check 'Releases' in 5 mins.";
            status.style.background = "#2e7d32";
        }
    } catch (e) {
        status.innerHTML = "‚ùå Auto-Sync Failed: " + e.message;
    }
}
